name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run all tests
        run: ./gradlew test --no-daemon --stacktrace

      - name: Run ktlint check
        run: ./gradlew ktlintCheck --no-daemon --stacktrace

  build-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build artifacts
        run: ./gradlew build --no-daemon --stacktrace

      - name: Generate Dokka documentation
        run: ./gradlew dokkaHtml --no-daemon --stacktrace

      - name: Create documentation archive
        run: |
          cd drand-client/build/dokka/html
          zip -r ../../../../api-docs.zip .
          cd ../../../..

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            drand-client/build/libs/*.jar
            api-docs.zip

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-artifacts

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          # Extract the changelog section for this version
          CHANGELOG=$(awk "/## \[$VERSION\]/,/## \[/{if (/## \[/ && NR!=1) exit; print}" CHANGELOG.md)
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.get_version.outputs.VERSION }}
          body: |
            # Drand Kotlin Client v${{ steps.get_version.outputs.VERSION }}

            ${{ steps.changelog.outputs.CHANGELOG }}

            ## Installation

            ### JitPack
            ```kotlin
            repositories {
                maven("https://jitpack.io")
            }

            dependencies {
                implementation("com.github.USERNAME:drand-client-kotlin:${{ steps.get_version.outputs.VERSION }}")
            }
            ```

            ## Documentation
            - [API Documentation](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.VERSION }}/api-docs.zip)
            - [README](https://github.com/${{ github.repository }}/blob/v${{ steps.get_version.outputs.VERSION }}/README.md)
          files: |
            drand-client/build/libs/*.jar
            api-docs.zip
          draft: false
          prerelease: false

  # Uncomment when Maven Central is set up
  # publish-maven-central:
  #   name: Publish to Maven Central
  #   runs-on: ubuntu-latest
  #   needs: validate
  #   if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Set up JDK 11
  #       uses: actions/setup-java@v4
  #       with:
  #         java-version: '11'
  #         distribution: 'temurin'
  #         cache: 'gradle'
  #
  #     - name: Grant execute permission for gradlew
  #       run: chmod +x gradlew
  #
  #     - name: Publish to Maven Central
  #       env:
  #         OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
  #         OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
  #         SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
  #         SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
  #         SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
  #       run: |
  #         echo "$SIGNING_KEY" | base64 -d > $HOME/signing.gpg
  #         ./gradlew publishToSonatype closeAndReleaseSonatypeStagingRepository \
  #           -Psigning.keyId=$SIGNING_KEY_ID \
  #           -Psigning.password=$SIGNING_PASSWORD \
  #           -Psigning.secretKeyRingFile=$HOME/signing.gpg \
  #           -PossrhUsername=$OSSRH_USERNAME \
  #           -PossrhPassword=$OSSRH_PASSWORD \
  #           --no-daemon --stacktrace
